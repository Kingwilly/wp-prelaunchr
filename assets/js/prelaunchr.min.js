jQuery( document ).ready(function( $ ) {

	var pid;
	var rid;
	var cookie_pid = $.cookie('prelaunchr[id]');
	var email;

	if ( cookie_pid == undefined ) {

		/**
		 * If no existing uuid generate a new uuid and set a new cookie
		 */
		pid = uuid.v4();
		$.cookie( 'prelaunchr[id]' , pid , { expires: 730, path: '/' });

	} else {

		/**
		 * Use the existing uuid
		 */
		pid = cookie_pid; 

	}

	$('.prelaunchr .response').hide();

	$('.pform').submit(function(e){

		e.preventDefault();

		email = $.trim( $(this).find("input[type='email']").val() );

		rid = getUrlParameter('ref');

		if ( email ) {

			$.ajax({

				type: 'POST',
				url: PrelaunchrSubmit.ajaxurl,
				data: {
					'action'	: 'prelaunchr-submit', 
					'pid'		: pid,
					'email'		: email,
					'rid'		: rid
				},
				dataType: 'JSON',
				success: function( response, textStatus, XMLHttpRequest ) {

					//console.log( response );

					/**
					 * If email passes server validation and is stored
					 */
					if ( response.success ) {
						window.location.href = '/'+PrelaunchrSubmit.return+'/'+response.data.pid;
					} else {
						$('.prelaunchr .response').html(response.data).fadeIn();
					}

				},
				error: function( XMLHttpRequest, textStatus, errorThrown) {
					console.log( errorThrown );
				},
				complete: function( XMLHttpRequest, textStatus) {
					//something
				}

			});

		}

	});

});

/**
 * Get a specific url paramater
 *
 * http://stackoverflow.com/questions/19491336/get-url-parameter-jquery
 */
function getUrlParameter(sParam) {

	var sPageURL = window.location.search.substring(1);

	var sURLVariables = sPageURL.split('&');

	for (var i = 0; i < sURLVariables.length; i++) {

		var sParameterName = sURLVariables[i].split('=');

		if (sParameterName[0] == sParam) {

			return sParameterName[1];

		}

	}

}